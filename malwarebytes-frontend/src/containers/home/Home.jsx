import React, { useEffect, useRef } from "react";
import { useSelector, useDispatch } from "react-redux";
import { Layout, Modal } from "antd";

import { fetchDevices } from "../../store/device/thunk";
import { updateCart } from "../../store/cart/slice";
import { setIsHidden } from "../../store/modal/slice";
import ProductList from "../../components/product-list/ProductList";

import "./home.css";

const Home = () => {
  let modalRef = useRef();
  const dispatch = useDispatch();
  const devices = useSelector((state) => state.device.devices);
  const isHidden = useSelector((state) => state.modal.isHidden);
  const changes = useSelector((state) => state.modal.changes);
  const totalItems = useSelector((state) => state.cart.totalItems);

  useEffect(() => {
    dispatch(fetchDevices());
    dispatch(updateCart());
  }, [dispatch]);

  useEffect(() => {
    window.addEventListener("storage", () => dispatch(updateCart()));

    return () =>
      window.removeEventListener("storage", () => dispatch(updateCart()));
  });

  useEffect(() => {
    const onClose = () => {
      modalRef.current.destroy();
      modalRef.current = null;
      dispatch(setIsHidden({ isHidden: false }));
    };

    if (!isHidden) {
      const changedProducts = Object.entries(changes)
        .filter((entry) => entry[1] !== 0)
        .map((entry) => {
          const found = devices.find((device) => device.id === entry[0]);
          return [found, entry[1]];
        });

      const content = (
        <div>
          {changedProducts.map((entry) => {
            const product = entry[0];
            const diff = entry[1];

            return (
              <div key={product.id}>
                <span style={{ fontStyle: "italic", fontWeight: "bold" }}>
                  {product.name}
                </span>
                <span>{" quantity "}</span>
                <span style={{ color: diff > 0 ? "#3EAB00" : "#FF0210" }}>
                  {diff > 0 ? "increased" : "decreased"}
                </span>
                <span>{" by "}</span>
                <span style={{ fontWeight: "bold" }}>{Math.abs(diff)}</span>
              </div>
            );
          })}
        </div>
      );

      if (!modalRef.current) {
        modalRef.current = Modal.info({
          title: "Someone Changed the Data!",
          content,
          maskClosable: true,
          onOk: onClose,
          onCancel: onClose,
        });
      } else {
        modalRef.current.update({
          content,
        });
      }
    } else if (modalRef.current) {
      onClose();
    }
  }, [isHidden, changes, devices, dispatch]);

  return (
    <div>
      <Layout.Header className="home-header">
        <>
          <div>Malwarebytes Shop</div>
          <div>
            {"Items in cart: "}
            <span className="header-cart">
              {totalItems} {totalItems > 0 ? "items" : "item"}
            </span>
          </div>
        </>
      </Layout.Header>
      <Layout.Content className="home-site-layout">
        <div className="home-content">
          <ProductList list={devices} />
        </div>
      </Layout.Content>
    </div>
  );
};

export default Home;
